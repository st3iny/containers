#!/bin/sh

if [ -z "$CACHE_DIR" ] \
    || [ -z "$RCLONE_CONFIG" ] \
    || [ -z "$RCLONE_INCLUDE_FROM" ] \
    || [ -z "$RCLONE_TARGET" ] \
    || [ -z "$MIRROR_LIST" ]
then
    echo 'Requires CACHE_DIR, RCLONE_CONFIG, RCLONE_INCLUDE_FROM, RCLONE_TARGET and MIRROR_LIST to be set'
    exit 1
fi

if [ -n "$PRUNE" ]; then
    echo 'Pruning remote cache'
    rclone_cmd=sync
else
    rclone_cmd=copy
fi

mirror=rsync://"$(shuf -n 1 "$MIRROR_LIST")"
echo "Syncing from $mirror"

set -e
set -x

mkdir -p "$CACHE_DIR"

rsync \
    -vh \
    -rlptH \
    --safe-links \
    --delete-delay \
    --delay-updates \
    --exclude=/iso \
    --exclude=/archive \
    --exclude=/other \
    --exclude=/sources \
    --exclude=/images \
    --exclude=/*-unstable \
    --delete-excluded \
    "$mirror" "$CACHE_DIR"/

rclone "$rclone_cmd" \
    -v \
    --config="$RCLONE_CONFIG" \
    --include-from="$RCLONE_INCLUDE_FROM" \
    --copy-links \
    "$CACHE_DIR"/ \
    "$RCLONE_TARGET"/
