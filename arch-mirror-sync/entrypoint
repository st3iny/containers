#!/bin/sh

if [ -z "$CACHE_DIR" ] \
    || [ -z "$RCLONE_CONFIG" ] \
    || [ -z "$RCLONE_INCLUDE_FROM" ] \
    || [ -z "$RCLONE_TARGET" ]
then
    echo 'Requires CACHE_DIR, RCLONE_CONFIG, RCLONE_INCLUDE_FROM and RCLONE_TARGET to be set'
    exit 1
fi

set -e

echo 'Creating cache dir ...'
mkdir -p "$CACHE_DIR"

echo 'Syncing arch repository from mirror ...'
rsync \
    -vh \
    -rlptH \
    --safe-links \
    --delete-delay \
    --delay-updates \
    rsync://mirror.23m.com/archlinux/ "$CACHE_DIR"/

echo 'Syncing arch repository to s3 bucket ...'
rclone sync \
    -v \
    --config="$RCLONE_CONFIG" \
    --include-from="$RCLONE_INCLUDE_FROM" \
    --delete-excluded \
    --copy-links \
    "$CACHE_DIR"/ \
    "$RCLONE_TARGET"/
